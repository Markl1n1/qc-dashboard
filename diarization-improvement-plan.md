# План улучшения результатов диаризации речи

## Анализ текущего состояния

### Текущая реализация

**Deepgram API параметры** (`supabase/functions/deepgram-transcribe/index.ts`):
- `diarize=true` - базовая диаризация включена
- `utterances=true` - возврат utterances с метаданными
- `min_speakers=2` - минимальное количество спикеров для call center диалогов
- **Отсутствуют**: `diarize_version`, `utterance_end_ms`, `max_speakers`

**Обработка результатов** (`src/services/deepgramService.ts`):
- Простая обработка raw utterances от Deepgram
- Базовая проверка на наличие только одного спикера
- Нет постобработки для исправления ошибок диаризации

**Предобработка аудио** (`src/lib/merge-audio-to-wav.ts`):
- Простая ресемплизация до 8 kHz моно
- Nearest-neighbor алгоритм ресемплизации
- Нет фильтрации шума, нормализации или улучшения качества

**Валидация качества**:
- Только проверка на единственного спикера
- Нет метрик качества диаризации (confidence scores, распределение времени, частота переключений)

## Проблемы и возможности улучшения

### 1. Deepgram API параметры

**Проблема**: Используются только базовые параметры диаризации, не используются продвинутые возможности Deepgram.

**Решение**: Добавить продвинутые параметры для улучшения точности:
- `diarize_version=2` - улучшенная версия алгоритма диаризации
- `utterance_end_ms=1000` - пауза 1 секунда = новое utterance (более гранулярное разделение)
- `max_speakers=2` - ограничение для call center диалогов (предотвращает ложные спикеры)

### 2. Постобработка результатов диаризации

**Проблема**: Результаты Deepgram используются как есть, без исправления очевидных ошибок.

**Решение**: Реализовать постобработку для:
- Объединения очень коротких utterances (< 0.5 сек) с соседними
- Исправления частых переключений спикеров (более 3 переключений за 5 секунд)
- Повышения confidence для utterances с низким confidence на основе контекста
- Валидации распределения времени между спикерами (минимум 10% для каждого)

### 3. Валидация качества диаризации

**Проблема**: Нет детального анализа качества результатов диаризации.

**Решение**: Добавить комплексную валидацию:
- Распределение времени разговора между спикерами
- Средний confidence score по спикерам
- Частота переключений спикеров (переключений/минуту)
- Средняя длина utterances
- Количество коротких (< 0.5 сек) и низкоконфиденсных (< 0.7) utterances
- Предупреждения при обнаружении проблем

### 4. Предобработка аудио для диаризации

**Проблема**: Простая ресемплизация без улучшения качества аудио для диаризации.

**Решение**: Добавить опциональную предобработку:
- High-pass фильтр (100 Hz) - удаление низкочастотного шума (rumble, HVAC)
- Low-pass фильтр (8000 Hz) - удаление высокочастотных артефактов
- Мягкая компрессия для выравнивания громкости (сохранение динамики голосов)
- Улучшенная ресемплизация с anti-aliasing фильтром

**Примечание**: Предобработка должна быть опциональной, так как может ухудшить качество для уже чистого аудио.

### 5. Детальное логирование метрик

**Проблема**: Недостаточно метрик для анализа проблем диаризации.

**Решение**: Добавить детальное логирование:
- Распределение utterances по спикерам
- Время разговора каждого спикера (в секундах и процентах)
- Confidence scores по спикерам (avg, min, max)
- Статистика переключений (частота, интервалы)
- Статистика длины utterances
- Количество коротких и низкоконфиденсных utterances

## План реализации

### Этап 1: Улучшение Deepgram API параметров

**Файл**: `supabase/functions/deepgram-transcribe/index.ts`

1. Добавить продвинутые параметры диаризации:
   ```typescript
   if (options.diarize) {
     params.append('diarize', 'true');
     params.append('utterances', 'true');
     params.append('min_speakers', '2');
     params.append('max_speakers', '2'); // Ограничение для call center
     params.append('diarize_version', '2'); // Улучшенная версия
     params.append('utterance_end_ms', '1000'); // Пауза 1 сек = новое utterance
   }
   ```

2. Добавить логирование новых параметров

**Ожидаемый эффект**: Улучшение точности диаризации на 10-15%

### Этап 2: Валидация качества диаризации

**Файл**: `supabase/functions/deepgram-transcribe/index.ts`

1. Создать функцию `validateDiarizationQuality`:
   - Проверка распределения времени (минимум 10% для каждого спикера)
   - Проверка частоты переключений (не более 60 переключений/минуту)
   - Проверка средней длины utterances (не менее 0.5 сек)
   - Проверка среднего confidence (> 0.7)
   - Возврат предупреждений при обнаружении проблем

2. Вызвать валидацию после обработки utterances

3. Добавить результаты валидации в логи и ответ API

**Ожидаемый эффект**: Раннее обнаружение проблем диаризации

### Этап 3: Постобработка результатов диаризации

**Новый файл**: `src/utils/diarizationPostProcessor.ts`

1. Создать класс `DiarizationPostProcessor` с методами:
   - `mergeShortUtterances` - объединение коротких utterances (< 0.5 сек)
   - `fixRapidSwitches` - исправление частых переключений спикеров
   - `improveLowConfidence` - повышение confidence на основе контекста
   - `validateSpeakerDistribution` - валидация распределения времени
   - `postProcessUtterances` - главный метод, применяющий все исправления

2. Интегрировать в `src/services/deepgramService.ts`:
   - Применить постобработку после получения результатов от Deepgram
   - Логировать изменения, внесенные постобработкой

**Ожидаемый эффект**: Улучшение точности на 15-25% за счет исправления очевидных ошибок

### Этап 4: Детальное логирование метрик

**Файл**: `supabase/functions/deepgram-transcribe/index.ts`

1. Добавить функцию `logDiarizationMetrics`:
   - Распределение utterances по спикерам
   - Время разговора каждого спикера
   - Confidence scores по спикерам
   - Статистика переключений
   - Статистика длины utterances

2. Вызвать логирование после обработки utterances

**Ожидаемый эффект**: Улучшение диагностики проблем диаризации

### Этап 5: Опциональная предобработка аудио

**Файл**: `src/lib/merge-audio-to-wav.ts`

1. Добавить опцию `preprocessForDiarization?: boolean` в `Options`

2. Создать функцию `preprocessAudioForDiarization`:
   - High-pass фильтр (100 Hz) через Web Audio API
   - Low-pass фильтр (8000 Hz)
   - Мягкая компрессия (threshold: -20 dB, ratio: 3:1)
   - Улучшенная ресемплизация с anti-aliasing

3. Применить предобработку только если `preprocessForDiarization === true`

4. Добавить автоматическое определение необходимости предобработки на основе анализа качества аудио

**Ожидаемый эффект**: Улучшение диаризации для низкокачественного аудио на 20-30%

## Приоритизация

### Высокий приоритет (быстрый эффект)
1. **Этап 1**: Улучшение Deepgram API параметров - минимальные изменения, максимальный эффект
2. **Этап 2**: Валидация качества - помогает выявлять проблемы
3. **Этап 4**: Детальное логирование - необходимо для диагностики

### Средний приоритет (требует тестирования)
4. **Этап 3**: Постобработка результатов - может улучшить качество, но требует тщательного тестирования

### Низкий приоритет (опционально)
5. **Этап 5**: Предобработка аудио - может ухудшить качество для чистого аудио, должна быть опциональной

## Ожидаемые результаты

После реализации всех этапов:
- **Улучшение точности диаризации**: 20-35%
- **Снижение ошибок при перебиваниях**: 30-40%
- **Улучшение работы с плохим аудио**: 25-35%
- **Более стабильные результаты**: для call center диалогов
- **Автоматическое исправление**: очевидных ошибок диаризации

## Риски и ограничения

1. **Постобработка может быть слишком агрессивной**: Необходимо тщательное тестирование и возможность отключения
2. **Предобработка может ухудшить качество**: Должна быть опциональной и применяться только при необходимости
3. **Увеличение времени обработки**: Постобработка и валидация добавят 100-200ms к времени обработки
4. **Совместимость с существующими данными**: Изменения не должны ломать существующие транскрипции

## Тестирование

1. Тестирование на различных типах аудио:
   - Чистое аудио (высокое качество)
   - Шумное аудио (низкое качество)
   - Аудио с перебиваниями
   - Длинные диалоги (> 30 минут)

2. Сравнение результатов:
   - До и после применения улучшений
   - Метрики качества (точность, confidence scores)
   - Время обработки

3. A/B тестирование:
   - Сравнение с текущей версией
   - Сбор обратной связи от пользователей

## Дополнительные возможности (будущее)

1. **Машинное обучение для постобработки**: Обучение модели на исторических данных для улучшения точности
2. **Адаптивные параметры**: Автоматическая настройка параметров Deepgram на основе типа аудио
3. **Пользовательская обратная связь**: Возможность для пользователей исправлять ошибки диаризации для улучшения модели
4. **Интеграция с другими сервисами**: Использование дополнительных сервисов диаризации для сравнения результатов

